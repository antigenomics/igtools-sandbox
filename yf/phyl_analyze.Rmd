---
title: "Phylogenetic analysis of clonal trees"
author: "Anna Obraztsova"
date: "2/16/2017"
output: pdf_document
---

Diameter is the largest number of mutations between root and leave.
Branching is a number of leaves divided by mean length of path from root to leave.
Total.freq is a sum of frequencies of all vertices of tree.

```{r, warning=FALSE, message=FALSE, fig.height=10}
library(ggplot2)
library(stringr)
library(reshape2)
library(dplyr)
library(ggbeeswarm)

old_rna = c("Abdulain", "Ilgen", "Mamaev", "Smirnov", "Vlasov")
young_rna = c("Antipyat", "Epifancev", "Hadjibekov", "Koshkin", "Kovalchuk")

gs <- data.frame()

for (sample in old_rna){
  .df <- read.table(paste('~/yf/trees/stat/yf_old_RNA/', sample, ".txt", sep = ""), header=T, sep="\t")
	.df$proj <- "old"
	.df$sample <- sample
	gs <- rbind(gs, .df)
}

for (sample in young_rna){
	.df <- read.table(paste('~/yf/trees/stat/yf_young_RNA/', sample, ".txt", sep = ""), header=T, sep="\t")
	.df$proj <- "young"
	.df$sample <- sample
	gs <- rbind(gs, .df)
}

gs <- mutate_each(gs, funs(as.double(.)), -cdr3nt, -proj, -sample, -single)

gs2 <- gs %>% melt(id=c('root', 'cdr3nt', 'proj', 'sample')) %>% 
  mutate(name=paste(str_sub(proj, 1, 1), str_sub(sample,1, 3), sep='.')) %>%
  filter(variable != 'total.nodes' & variable != 'mean.path')
  
first = c('freq', 'freq.sum', 'leaves', 'root.mut', 'diameter', 'total.mut', 'mean.degree')

ggplot(filter(gs2, variable %in% first)) + geom_quasirandom(aes(x = name, y = value, group=proj, fill = proj), varwidth = TRUE, shape=21, color="black") +
facet_wrap(~variable, nrow=4, scales='free') +
scale_fill_brewer("", palette = "Set1") +
theme_bw() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r, fig.height=9}
for (i in first){
  cat(i, 't-Test p-value\n', p.adjust(t.test(gs[[i]] ~ gs[['proj']])$p.value, method="bonferroni"), '\n')
}
```



```{r, warning=FALSE, message=FALSE, fig.height=3, fig.width=3, fig.show = 'hold'}
gs3 <- gs2 %>% dplyr::group_by(sample, proj) %>% dplyr::summarise(n = n())
ggplot(gs3) + geom_boxplot(aes(x = proj, y = n)) + ggtitle('Total number of clonal families')

t.test(n ~ proj, gs3)
```


```{r, warning=FALSE, message=FALSE, fig.height=3, fig.width=3, fig.show = 'hold'}
gs4 <- gs %>% mutate(single = ifelse(single==TRUE, 'single', 'tree')) %>% 
  dplyr::group_by(sample, proj, single) %>% dplyr::summarise(n = n()) %>%
  dcast(sample + proj ~ single)
ggplot(gs4, aes(x=proj, y = single/tree)) + geom_boxplot() + ggtitle('Single clones number to clonal trees number')

t.test(single/tree ~ proj, gs4)
```


```{r, warning=FALSE, message=FALSE, fig.height=3, fig.width=3, fig.show = 'hold'}
gs4.1 <- gs %>% mutate(single = ifelse(single==TRUE, 'single', 'tree')) %>% 
  dplyr::group_by(sample, proj, single) %>% dplyr::summarise(n = sum(freq.sum)) %>%
  dcast(sample + proj ~ single)
ggplot(gs4.1, aes(x=proj, y = single/tree)) + geom_boxplot() + ggtitle('Single clones total frequency to clonal trees total frequency')

t.test(single/tree ~ proj, gs4.1)
```


```{r}
gs4.2 <- gs %>% mutate(name=paste(str_sub(proj, 1, 1), str_sub(sample,1, 3), sep='.'))
ggplot(gs4.2, aes(x = single, y = root.mut, fill=proj)) + geom_boxplot() + ggtitle('SHM number in root') +
theme(axis.text.x = element_text(angle = 45, hjust = 1))

a <- aov(root.mut~ single * proj, gs4.2)
summary(a)
```
