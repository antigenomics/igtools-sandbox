---
title: "Distribution, RS ratio and patterns of SHM"
author: "Mikhail Shugay, Anna Obraztsova"
date: "11/17/2016"
output: html_document
---

Load preprocessed data

```{r, warning=FALSE, message=FALSE}
library(plyr)
library(ggplot2)
load("sp.Rda")
df$region <- factor(df$region, c("FR1","CDR1","FR2","CDR2","FR3","CDR3"))
df$mutation.type <- ifelse(df$from.aa == df$to.aa, "S", "R")
```

Check if we observe well-documented increase in replacement:synonimic hypermutation ratio in CDR regions:

```{r}
ggplot(subset(df.5, type == "RNA")) + 
  geom_bar(aes(x=pos.aa, weight=weight, fill=region)) +
  geom_density(aes(x=pos.aa, weight=weight, linetype = mutation.type), size=1) +
  ylab("SHM density") +
  xlab("Position in IG, AA") +
  scale_fill_brewer(palette = "Set1") +
  theme_bw()
```

### Comparative analysis

Groom and summarize

```{r}
df.1 <- ddply(df, .(proj, sample, type, replica, mutation.type, region), summarize,
              count = sum(total.clonotypes))
```

Comparing mutation density across regions for old and young:

```{r}
df.2 <- ddply(df.1, .(proj, sample, type, replica, region), summarize, count = sum(count))
df.2 <- ddply(df.2, .(proj, sample, type, replica), transform, freq = count / sum(count))

# DNA data

ggplot(subset(df.2, type == "DNA"), aes(x = proj, group = proj, y = freq, fill = proj)) +
  geom_boxplot() + scale_fill_brewer(palette = "Set1") +
  facet_wrap(~region, scales="free_y") +
  theme_bw()

a <- aov(freq ~ proj * region, subset(df.2, type == "DNA"))
summary(a)

# RNA data

ggplot(subset(df.2, type == "RNA"), aes(x = proj, group = proj, y = freq, fill = proj)) +
  geom_boxplot() + scale_fill_brewer(palette = "Set1") +
  facet_wrap(~region, scales="free_y") +
  theme_bw()

a <- aov(freq ~ proj * region, subset(df.2, type == "RNA"))
summary(a)
```

Compare overall R:S ratios:

```{r}
df.3 <- ddply(df.1, .(proj, sample, type, replica, mutation.type), summarize, count = sum(count))
df.3 <- subset(ddply(df.3, .(proj, sample, type, replica), transform, share = count / (sum(count) - count)),
               mutation.type == "R")

# DNA data

ggplot(subset(df.3, type == "DNA"), aes(x=proj, group=proj, y=share, fill=proj)) + 
  geom_boxplot() + ylab("R:S ratio") + 
  scale_fill_brewer(palette = "Set1") +
  theme_bw()

t.test(share ~ proj, subset(df.3, type == "DNA"))

# RNA data

ggplot(subset(df.3, type == "RNA"), aes(x=proj, group=proj, y=share, fill=proj)) + 
  geom_boxplot() + ylab("R:S ratio") + 
  scale_fill_brewer(palette = "Set1") +
  theme_bw()

t.test(share ~ proj, subset(df.3, type == "RNA"))
```

Compare R:S ratio by region:

```{r}
df.4 <- ddply(df.1, .(proj, sample, type, replica, mutation.type, region), summarize, count = sum(count))
df.4 <- subset(ddply(df.4, .(proj, sample, type, replica, region), transform, share = count / (sum(count) - count)),
               mutation.type == "R")

# DNA data

ggplot(subset(df.4, type == "DNA"), aes(x=proj, group=proj, y=share, fill=proj)) + 
  geom_boxplot() + ylab("R:S ratio") + 
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~region, scales="free_y") +
  theme_bw()

a <- aov(share ~ proj * region, subset(df.4, type == "DNA"))
summary(a)

# RNA data

ggplot(subset(df.4, type == "RNA"), aes(x=proj, group=proj, y=share, fill=proj)) + 
  geom_boxplot() + ylab("R:S ratio") + 
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~region, scales="free_y") +
  theme_bw()

a <- aov(share ~ proj * region, subset(df.4, type == "RNA"))
summary(a)
```

Plot R/S by amino acid position (RNA only):

```{r}
df.5 <- ddply(df, .(proj, type, sample, replica), transform, weight = total.clonotypes / sum(total.clonotypes))

ggplot(subset(df.5, type == "RNA"), aes(x=pos.aa, weight=weight, color=proj)) + 
  geom_density() +
  facet_grid(mutation.type~., scales="free_y") + scale_color_brewer(palette = "Set1") +
  theme_bw()
```

Mutation patterns (nucleotide):

```{r}
df.6 <- ddply(df, .(proj, type, sample, replica, from.nt, to.nt), summarize, count = sum(total.clonotypes))
df.6 <- ddply(df.6, .(proj, type, sample, replica), transform, share = count / sum(count))

ggplot(subset(df.6, type=="DNA"), 
       aes(x = interaction(from.nt, to.nt), group = interaction(from.nt, to.nt, proj), y = share, fill = proj)) +
  geom_boxplot() + 
  scale_fill_brewer(palette = "Set1") + 
  theme_bw()

ggplot(subset(df.6, type=="RNA"), 
       aes(x = interaction(from.nt, to.nt), group = interaction(from.nt, to.nt, proj), y = share, fill = proj)) +
  geom_boxplot() + scale_fill_brewer(palette = "Set1") +
  theme_bw()
```

Mutation patterns (amino acid):

```{r}
df.6 <- ddply(df, .(proj, type, sample, replica, from.aa, to.aa), summarize, count = sum(total.clonotypes))
df.6 <- ddply(df.6, .(proj, type, sample, replica), transform, share = count / sum(count))

ggplot(subset(df.6, type=="RNA"), 
       aes(x = from.aa, y=to.aa, fill = log10(share))) +
  geom_tile() + 
  facet_wrap(~proj) +
  #scale_fill_brewer(palette = "Set1") + 
  theme_bw()
```

